<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人運動追蹤紀錄 (Firebase版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: '微軟正黑體', sans-serif; background-color: #f3f4f6; }
        .hidden { display: none; }
        /* 載入中的轉圈圈動畫 */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-2xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        
        <div class="bg-indigo-600 p-4 text-white text-center">
            <h1 class="text-2xl font-bold"><i class="fas fa-fire mr-2"></i>雲端運動紀錄</h1>
            <p class="text-sm opacity-80 mt-1">資料同步儲存於 Firebase</p>
        </div>

        <div class="p-6">
            <form id="exerciseForm" class="space-y-4">
                <input type="hidden" id="recordId"> <div>
                    <label class="block text-gray-700 font-bold mb-1">日期</label>
                    <input type="date" id="date" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-1">運動項目</label>
                    <select id="type" class="w-full border rounded p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="running">跑步</option>
                        <option value="plank">平板撐</option>
                        <option value="other">其他</option>
                    </select>
                </div>

                <div id="runningFields" class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-600 text-sm">距離 (公里/km)</label>
                        <input type="number" id="runDistance" step="0.1" placeholder="例如: 5.0" class="w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-gray-600 text-sm">時間 (分鐘)</label>
                        <input type="number" id="runTime" placeholder="例如: 30" class="w-full border rounded p-2">
                    </div>
                </div>

                <div id="plankFields" class="hidden grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-600 text-sm">單次時間 (秒)</label>
                        <input type="number" id="plankTime" placeholder="例如: 60" class="w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-gray-600 text-sm">幾組</label>
                        <input type="number" id="plankSets" placeholder="例如: 3" class="w-full border rounded p-2">
                    </div>
                </div>

                <div>
                    <label class="block text-gray-700 font-bold mb-1">備註</label>
                    <textarea id="notes" rows="2" placeholder="今天狀況如何？或其他運動內容..." class="w-full border rounded p-2"></textarea>
                </div>

                <div class="flex gap-2">
                    <button type="submit" id="submitBtn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition">
                        <i class="fas fa-cloud-upload-alt mr-1"></i> 儲存至雲端
                    </button>
                    <button type="button" id="cancelBtn" class="hidden flex-1 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded transition">
                        取消編輯
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-gray-50 border-t p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex justify-between items-center">
                歷史紀錄
                <button id="refreshBtn" class="text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 px-2 py-1 rounded">
                    <i class="fas fa-sync-alt"></i> 重新整理
                </button>
            </h2>
            
            <div id="loading" class="loader hidden"></div>
            
            <div id="recordList" class="space-y-3">
                </div>
        </div>
    </div>

    <script type="module">
        // 引入 Firebase 必要的函式庫
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            query, 
            orderBy 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // 您的 Firebase 設定
        const firebaseConfig = {
            apiKey: "AIzaSyDJcIZuFnNa-RFRIpgZbvTYd82g_hC8_To",
            authDomain: "sport-2ab23.firebaseapp.com",
            projectId: "sport-2ab23",
            storageBucket: "sport-2ab23.firebasestorage.app",
            messagingSenderId: "134044589100",
            appId: "1:134044589100:web:b309d1f1544683c9b10589",
            measurementId: "G-0YD9060YC9"
        };

        // 初始化 Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const COLLECTION_NAME = "exercises"; // 資料庫集合名稱

        // --- 將功能綁定到 window 物件，以便 HTML onclick 可以呼叫 ---

        // 1. 切換顯示欄位
        window.toggleFields = function() {
            const type = document.getElementById('type').value;
            const runningFields = document.getElementById('runningFields');
            const plankFields = document.getElementById('plankFields');

            runningFields.classList.add('hidden');
            plankFields.classList.add('hidden');

            if (type === 'running') {
                runningFields.classList.remove('hidden');
            } else if (type === 'plank') {
                plankFields.classList.remove('hidden');
            }
        };

        // 2. 載入資料 (Read)
        window.loadRecords = async function() {
            const listContainer = document.getElementById('recordList');
            const loader = document.getElementById('loading');
            
            listContainer.innerHTML = '';
            loader.classList.remove('hidden'); // 顯示讀取圈圈

            try {
                // 依日期降序排列 (最新的在上面)
                const q = query(collection(db, COLLECTION_NAME), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);
                
                loader.classList.add('hidden'); // 隱藏讀取圈圈

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center">目前沒有紀錄。</p>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const record = doc.data();
                    record.id = doc.id; // 把 ID 存進去方便之後修改刪除
                    renderRecordItem(record, listContainer);
                });

            } catch (error) {
                console.error("讀取失敗:", error);
                loader.classList.add('hidden');
                listContainer.innerHTML = `<p class="text-red-500 text-center">讀取失敗，請檢查網路或 Firebase 權限。<br><small>${error.message}</small></p>`;
            }
        };

        // 渲染單筆紀錄的 HTML
        function renderRecordItem(record, container) {
            let typeLabel = '';
            let detailText = '';
            let iconClass = '';
            let bgColor = '';

            if (record.type === 'running') {
                typeLabel = '跑步';
                iconClass = 'fa-running';
                bgColor = 'bg-green-100 text-green-800';
                detailText = `距離: ${record.details.distance || 0} km / 時間: ${record.details.time || 0} 分`;
            } else if (record.type === 'plank') {
                typeLabel = '平板撐';
                iconClass = 'fa-child';
                bgColor = 'bg-orange-100 text-orange-800';
                detailText = `時間: ${record.details.time || 0} 秒 / 組數: ${record.details.sets || 0} 組`;
            } else {
                typeLabel = '其他';
                iconClass = 'fa-bicycle';
                bgColor = 'bg-gray-100 text-gray-800';
                detailText = '自定義訓練';
            }

            const item = document.createElement('div');
            item.className = 'bg-white border rounded-lg p-3 shadow-sm flex flex-col md:flex-row justify-between items-start md:items-center gap-2';
            item.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="text-gray-500 text-sm font-mono">${record.date}</span>
                        <span class="${bgColor} text-xs px-2 py-1 rounded-full font-bold">
                            <i class="fas ${iconClass} mr-1"></i>${typeLabel}
                        </span>
                    </div>
                    <div class="font-bold text-gray-800">${detailText}</div>
                    ${record.notes ? `<div class="text-gray-500 text-sm mt-1"><i class="fas fa-sticky-note mr-1"></i>${record.notes}</div>` : ''}
                </div>
                <div class="flex gap-2 mt-2 md:mt-0">
                    <button onclick="window.prepareEdit('${record.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 text-sm transition">
                        <i class="fas fa-edit"></i> 修改
                    </button>
                    <button onclick="window.deleteRecord('${record.id}')" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm transition">
                        <i class="fas fa-trash"></i> 刪除
                    </button>
                </div>
            `;
            container.appendChild(item);
        }

        // 3. 儲存紀錄 (Create / Update)
        window.saveRecord = async function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            const originalBtnText = submitBtn.innerHTML;
            
            // 按鈕變為載入中狀態
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';

            try {
                const id = document.getElementById('recordId').value;
                const date = document.getElementById('date').value;
                const type = document.getElementById('type').value;
                const notes = document.getElementById('notes').value;
                
                let details = {};

                if (type === 'running') {
                    details = {
                        distance: document.getElementById('runDistance').value,
                        time: document.getElementById('runTime').value
                    };
                } else if (type === 'plank') {
                    details = {
                        time: document.getElementById('plankTime').value,
                        sets: document.getElementById('plankSets').value
                    };
                }

                const data = { date, type, details, notes };

                if (id) {
                    // 更新模式
                    const docRef = doc(db, COLLECTION_NAME, id);
                    await updateDoc(docRef, data);
                    alert("更新成功！");
                } else {
                    // 新增模式
                    await addDoc(collection(db, COLLECTION_NAME), data);
                    alert("新增成功！");
                }

                window.resetForm();
                window.loadRecords(); // 重新讀取列表

            } catch (error) {
                console.error("儲存錯誤:", error);
                alert("儲存失敗: " + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            }
        };

        // 4. 準備編輯 (將資料填回表單)
        // 注意：因為要從 Firestore 拿該筆資料的詳細內容，這裡我們直接從畫面上的變數或重新抓取都可以
        // 為了簡單，我們直接用全域變數暫存資料，或者再次查詢
        // 這裡採用: 因為我們剛剛 loadRecords 有把 ID 寫在 DOM 上，我們用 ID 去陣列找太慢，直接重抓一次單筆或傳遞參數
        // 簡單做法：我們在 loadRecords 時其實已經拿到資料，但為了不讓全域變數太亂，我們這裡用 "查詢單筆" 的方式，確保資料最新
        // 但為了效能，更好的方式是在 render 時把資料綁在 DOM 元素上。這裡為了程式碼好讀，我們稍微變通一下：
        // 修改 renderRecordItem 的按鈕，我們不實作複雜的傳遞，直接用 getDoc (雖然多一次請求但安全)
        // *修正*：為了避免太複雜，我們直接遍歷目前的 DOM 或重新整理邏輯。
        // 最簡單方式：我們建立一個暫存物件在 window 下。
        
        let currentRecordsCache = []; // 簡單的快取

        const originalLoadRecords = window.loadRecords;
        window.loadRecords = async function() {
            // 攔截原本的 loadRecords 來做快取
            const listContainer = document.getElementById('recordList');
            const loader = document.getElementById('loading');
            listContainer.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                const q = query(collection(db, COLLECTION_NAME), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);
                
                currentRecordsCache = []; // 清空快取
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    currentRecordsCache.push(data);
                });

                loader.classList.add('hidden');
                
                if (currentRecordsCache.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center">目前沒有紀錄。</p>';
                } else {
                    currentRecordsCache.forEach(record => renderRecordItem(record, listContainer));
                }
            } catch(e) {
                console.error(e);
                loader.classList.add('hidden');
            }
        }

        window.prepareEdit = function(id) {
            const record = currentRecordsCache.find(r => r.id === id);
            if (!record) return;

            document.getElementById('recordId').value = record.id;
            document.getElementById('date').value = record.date;
            document.getElementById('type').value = record.type;
            document.getElementById('notes').value = record.notes;

            window.toggleFields();

            if (record.type === 'running') {
                document.getElementById('runDistance').value = record.details.distance;
                document.getElementById('runTime').value = record.details.time;
            } else if (record.type === 'plank') {
                document.getElementById('plankTime').value = record.details.time;
                document.getElementById('plankSets').value = record.details.sets;
            }

            // 改變 UI 狀態
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-sync mr-1"></i> 更新紀錄';
            submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            
            document.getElementById('cancelBtn').classList.remove('hidden');
            
            // 滾動到頂部
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        // 5. 刪除紀錄
        window.deleteRecord = async function(id) {
            if (!confirm('確定要永久刪除這筆紀錄嗎？')) return;

            try {
                await deleteDoc(doc(db, COLLECTION_NAME, id));
                // 移除快取中的該筆資料
                currentRecordsCache = currentRecordsCache.filter(r => r.id !== id);
                // 重新渲染畫面 (不需要重新請求 API，節省流量)
                const listContainer = document.getElementById('recordList');
                listContainer.innerHTML = '';
                if (currentRecordsCache.length === 0) {
                    listContainer.innerHTML = '<p class="text-gray-500 text-center">目前沒有紀錄。</p>';
                } else {
                    currentRecordsCache.forEach(record => renderRecordItem(record, listContainer));
                }
                alert('已刪除');
            } catch (error) {
                alert('刪除失敗: ' + error.message);
            }
        };

        // 6. 重置表單
        window.resetForm = function() {
            document.getElementById('exerciseForm').reset();
            document.getElementById('recordId').value = '';
            document.getElementById('date').valueAsDate = new Date();
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.innerHTML = '<i class="fas fa-cloud-upload-alt mr-1"></i> 儲存至雲端';
            submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            
            document.getElementById('cancelBtn').classList.add('hidden');
            window.toggleFields();
        };

        // 綁定 DOM 事件
        document.getElementById('type').addEventListener('change', window.toggleFields);
        document.getElementById('exerciseForm').addEventListener('submit', window.saveRecord);
        document.getElementById('cancelBtn').addEventListener('click', window.resetForm);
        document.getElementById('refreshBtn').addEventListener('click', window.loadRecords);

        // 初始化
        document.getElementById('date').valueAsDate = new Date();
        window.loadRecords();

    </script>
</body>
</html>
